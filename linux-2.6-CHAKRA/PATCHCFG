# Kernel source file
SRC="ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-2.6.38.tar.bz2"
# Original source directory
SRCORIG="linux-2.6.38"
# Our source directory
SRCNAME="linux-2.6.38-CHAKRA"
# Patches:
#   URL%patchlevel
#  or
#   filename%patchlevel (file must be in patches subdirectory)
PATCHES=(
         # add upstream patch from 2.6.38 series
         http://www.kernel.org/pub/linux/kernel/v2.6/patch-2.6.38.2.bz2%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/alsa-hda-new-ad1984a-model-for-dell-precision-r5500.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/alsa-hda-fix-spdif-out-regression-on-alc889.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/alsa-fix-yet-another-race-in-disconnection.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/alsa-vmalloc-buffers-should-use-normal-mmap.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/perf-better-fit-max-unprivileged-mlock-pages-for-tools-needs.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/myri10ge-fix-rmmod-crash.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/cciss-fix-lost-command-issue.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/ath9k-fix-kernel-panic-in-ar2427.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/sound-oss-opl3-validate-voice-and-channel-indexes.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/mac80211-initialize-sta-last_rx-in-sta_info_alloc.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/ses-show-devices-for-enclosures-with-no-page-7.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/ses-avoid-kernel-panic-when-lun-0-is-not-mapped.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/pci-acpi-report-aspm-support-to-bios-if-not-disabled-from-command-line.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/x86-64-mm-put-early-page-table-high.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/ecryptfs-unlock-page-in-write_begin-error-path.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/ecryptfs-ecryptfs_keyring_auth_tok_for_sig-bug-fix.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/crypto-aesni-intel-fixed-problem-with-packets-that-are-not-multiple-of-64bytes.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/staging-usbip-bugfixes-related-to-kthread-conversion.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/staging-usbip-bugfix-add-number-of-packets-for-isochronous-frames.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/staging-usbip-bugfix-for-isochronous-packets-and-optimization.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/staging-hv-use-sync_bitops-when-interacting-with-the-hypervisor.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/38.3-pre/staging-hv-fix-garp-not-sent-after-quick-migration.patch%1

         # add latest fixes from stable queue, if needed
         # http://git.kernel.org/?p=linux/kernel/git/stable/stable-queue.git

         # add bugfixes
         # fix #19234 i1915 display size
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/fix-i915.patch%1
         # fix #23390 radeon kms
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/radeon-kms-sanity-checks.patch%1
         # fix i915 pipelining glitches
         # https://bugs.freedesktop.org/show_bug.cgi?id=34584
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/i915-pipeline.patch%1
         # fix ips module
         http://chakra-project.org/sources/kernel26/patches/38/bugfix/intel_ips-produces-constant-load-of-1.patch%1

         # add aufs2 support, in reference to:
         # http://aufs.sourceforge.net
         http://chakra-project.org/sources/kernel26/patches/38/aufs2.1/aufs2-kbuild-38.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/aufs2.1/aufs2-base-38.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/aufs2.1/aufs2-standalone-38.patch%1
         http://chakra-project.org/sources/kernel26/patches/38/aufs2.1/aufs2.1-standalone.tree-38-20110328.patch.bz2%1
        )
# Name of the resulting patch (will be bzipped afterwards)
PATCHNAME="patch-2.6.38.2-2-CHAKRA"

# Run this before applying patches
pre_apply() {
  :
}

# Run this after applying patches
post_apply() {
  # remove the extraversion from Makefile
  # this ensures our kernel version is always 2.6.XX-CHAKRA
  # this way, minor kernel updates will not break external modules
  sed -i 's|^EXTRAVERSION = .*$|EXTRAVERSION = |g' Makefile

  # Kill some files
  find . -name '*~' -exec rm -f {} \; 2>/dev/null
}
