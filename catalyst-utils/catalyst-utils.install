
pre_install(){
    CARD_ATI=$(lspci -n | sed -n "s/.* 0300: 1002:\(....\).*/\1/p")
    if [ "$CARD_ATI" != "" ]
    then
       [ $(grep -i "$CARD_ATI" hw_ati_legacy_hwdb) ]
    then
       echo "WARNING WARNING WARNING WARNING"
       echo "--------------------------------"
       echo "ATI LEGACY hardware detected"
       echo "This driver is not compatible, install catalyst-legacy before rebooting."
       echo "sudo pacman -S catalyst-legacy"
       echo "--------------------------------"
       echo "WARNING WARNING WARNING WARNING"
     fi
}

pre_upgrade(){
    CARD_ATI=$(lspci -n | sed -n "s/.* 0300: 1002:\(....\).*/\1/p")
    if [ "$CARD_ATI" != "" ]
    then
       [ $(grep -i "$CARD_ATI" hw_ati_legacy_hwdb) ]
    then
       echo "WARNING WARNING WARNING WARNING"
       echo "--------------------------------"
       echo "ATI LEGACY hardware detected"
       echo "This driver is not compatible, install catalyst-legacy before rebooting."
       echo "sudo pacman -S catalyst-legacy"
       echo "--------------------------------"
       echo "WARNING WARNING WARNING WARNING"
     fi
}

whisperer(){
    echo "----------------------------------------------------------------"
    echo "PLEASE NOTE:"
    echo "For these drivers to work, you must install kernel modules."
    echo "Depending on your kernel, these module packages are named"
    echo "catalyst-\$kernel and stock kernel module is catalyst"
    echo ""
    echo "OR simply use packages that provides auto re-compilation:"
    echo "catalyst-hook or catalyst-daemon"
    echo ""
    echo "OR use catalyst-generator package to generate catalyst-{kernver}"
    echo "packages"
    echo "----------------------------------------------------------------"
    echo "You can use the tool 'aticonfig' to generate an xorg.conf file."
    echo "--------------------- ^^^^^^^^^ --------------------------------"
    echo "Add nomodeset to your kernel line in /boot/grub/grub.cfg , ie.:"
    echo "kernel /boot/vmlinuz-linux root=/dev/sda1 ro nomodeset"
    echo "----------------------------------------------------------------"
    echo "For more info and troubleshooting visit:"
    echo "http://chakra-linux.org/wiki/index.php/Switching_Between_Free_and_Non-free_Video-Drivers"
    echo "----------------------------------------------------------------"
}

check_libdri_so(){
    if [ ! -e usr/lib/xorg/modules/extensions/libdri.so ]; then
        ln -sf usr/lib/xorg/modules/extensions/libdri.xorg usr/lib/xorg/modules/extensions/libdri.so
    fi
}

post_install(){
    check_libdri_so
    whisperer
}

post_upgrade(){
    check_libdri_so
    whisperer
}

post_remove(){
    # If the symlink is dead, remove it
     check_libdri_so
     echo "NOTE: Don't forget to recover your original xorg.conf file."
}
