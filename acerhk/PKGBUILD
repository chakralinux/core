#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

pkgname=acerhk
pkgver=0.5.35
pkgrel=11
pkgdesc="Acer hotkey driver"
url="http://www.cakey.de/acerhk/"
arch=('i686') # Unavailable for x86_64
license=('GPL')
depends=('linux>=3.0' 'linux<3.1')
makedepends=('linux-headers')
source=(http://www.cakey.de/acerhk/archives/${pkgname}-${pkgver}.tgz acerhk.rc
        2.6.30.patch kernelversion.patch 2.6.36.patch flag.patch medion.patch)
install=acerhk.install
# Find the kernel name inside the chroot
_kernver=`pacman -Q linux | cut -c7-9 | sed 's/linux //g'`-CHAKRA

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  sed -i 's/CFLAGS/EXTRA_CFLAGS/' Makefile
  sed \
    -e  's~#include <linux/config.h>~~g' \
    -i acerhk.c
  patch -Np1 -i "${srcdir}/2.6.30.patch"
  patch -Np0 -i "${srcdir}/2.6.36.patch"
  patch -N -p1 < "$srcdir/kernelversion.patch"
  patch -Np1 -i "${srcdir}/flag.patch"
  patch -Np0 -i "${srcdir}/medion.patch"

  # Set KERNELSRC.  The makefile tries to autodetect it with uname,
  # but that is unreliable.
  make KERNELSRC="/lib/modules/${_kernver}/build" acerhk.ko
  install -Dm644 "${srcdir}/${pkgname}-${pkgver}/acerhk.ko" \
    "${pkgdir}/lib/modules/${_kernver}/kernel/drivers/block/acerhk.ko"
  install -Dm755 "${srcdir}/acerhk.rc" "${pkgdir}/etc/rc.d/acerhk"
}

# vim:set ts=2 sw=2 et:
md5sums=('05255919f312cb76af473a760c284433'
         '935584b3e4bfbb3af8460558e5b98bb5'
         '2a0bc99e5b12e25096441df4d53d7df7'
         'fd2ef062ecbc9d670e1b42aa5866d32d'
         'd257a4e9223ebfde48b9608805df9c99'
         '7918e52ac88eb68a011bbf06482c35f6'
         '05b5f9454276f67a87fa894b7bee8b0a')
