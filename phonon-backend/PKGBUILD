#
# Phonon Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

# include global config
source ../_buildscripts/${current_repo}-${_arch}-cfg.conf

# original name (used for the source and pkgnames)
pkgbase=('phonon-backend')

pkgname=('phonon-backend-gstreamer'
	'phonon-backend-xine'
	'phonon-backend-mplayer'
	'phonon-backend-vlc')

pkgver=4.5.5
_gst=4.5.1
_xine=4.4.4
_vlc=0.4.1
_mplayer=${pkgver}.$(date +%Y%m%d)
pkgrel=4
pkgdesc='The multimedia API for Qt 4 and KDE 4'
arch=('i686' 'x86_64')
url='http://phonon.kde.org'
license=('LGPL')

makedepends=("qt>=${_qtver}"
	'pkgconfig'
	'cmake'
	'automoc4'
	'git'
	'mesa'
	'mplayer'
	'xine-lib'
	'vlc'
	'gstreamer0.10'
	'gstreamer0.10-base'
	'gstreamer0.10-base-plugins'
	'libpulse'
	"phonon>=${pkgver}")

source=("http://download.kde.org/stable/phonon/phonon-backend-gstreamer/${_gst}/src/phonon-backend-gstreamer-${_gst}.tar.bz2"
        "http://download.kde.org/stable/phonon/phonon-backend-xine/${_xine}/src/phonon-backend-xine-${_xine}.tar.bz2"
        "http://download.kde.org/stable/phonon/phonon-backend-vlc/${_vlc}/phonon-backend-vlc-${_vlc}.tar.bz2")

md5sums=('021cf7740208e7212b7ce91adb6a349b'
         'b127104e67538e573adeed3b2fb3bf55'
         'bdf188c0d3ad3458e7e39ecad06a500b')

build() {
	cd ${srcdir}
	mkdir -p build-phonon-gst
	cd build-phonon-gst
	cmake ../phonon-backend-gstreamer-${_gst} \
		 -DCMAKE_BUILD_TYPE=Release \
		 -DCMAKE_INSTALL_PREFIX=/usr
	make
	cd ${srcdir}
	mkdir -p build-phonon-xine
	cd build-phonon-xine
	cmake ../phonon-backend-xine-${_xine} \
		 -DCMAKE_BUILD_TYPE=Release \
		 -DCMAKE_INSTALL_PREFIX=/usr
	make
	cd ${srcdir}
	mkdir -p build-phonon-vlc
	cd build-phonon-vlc
	cmake ../phonon-backend-vlc-${_vlc} \
		 -DCMAKE_BUILD_TYPE=Release \
		 -DCMAKE_INSTALL_PREFIX=/usr
	make
}

package_phonon-backend-gstreamer()
{
	url="http://phonon.kde.org"
	pkgdesc="Phonon GStreamer backend"
	license=('LGPL')
	depends=('gstreamer0.10-base-plugins' "phonon>=${pkgver}")
	groups=("kde-complete" "kde-uninstall")
	conflicts=('phonon-gstreamer')
	replaces=('phonon-gstreamer')
	pkgver=$_gst

	cd ${srcdir}/build-phonon-gst
	make DESTDIR=${pkgdir} install
}

package_phonon-backend-xine()
{
	url="http://phonon.kde.org"
	pkgdesc="Phonon Xine backend"
	license=('LGPL')
	depends=('xine-lib' "phonon>=${pkgver}")
	groups=("kde-complete" "kde-uninstall")
	conflicts=('phonon-xine')
	replaces=('phonon-xine')
	pkgver=$_xine
	pkgrel=3

	cd ${srcdir}/build-phonon-xine
	make DESTDIR=${pkgdir} install
}

package_phonon-backend-mplayer()
{
	bename=mplayer
	pkgdesc="Phonon MPlayer backend"
	url="http://www.gitorious.org/phonon/phonon-${bename}"
	license=("LGPL")
	depends=("phonon>=${pkgver}" "${bename}")
	groups=("kde-complete" "kde-uninstall")
	conflicts=("phonon-${bename}-svn" 'phonon-mplayer')
	replaces=("phonon-${bename}-svn" 'phonon-mplayer')
	pkgver=$_mplayer
	pkgrel=1

	_gitroot="git://anongit.kde.org/phonon-${bename}.git"
	_gitname="phonon-${bename}"

	cd "$srcdir"

	msg "Connecting to GIT server...."
	if [ -d ${_gitname} ] ; then
		cd ${_gitname} && git pull origin
		msg "The local files are updated."
	else
		git clone ${_gitroot} ${_gitname}
	fi
	msg "GIT checkout done or server timeout"
	msg "Starting make..."

	rm -rf "${srcdir}/${_gitname}-build"
	git clone -l "${srcdir}/${_gitname}" "${srcdir}/${_gitname}-build"
	cd "${srcdir}/${_gitname}-build"

	# Config
	[ ${CARCH} = 'x86_64' ] && CXXFLAGS="$CXXFLAGS -fPIC"

	# Build
	cmake -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release \
		-DPLUGIN_INSTALL_DIR=/usr/lib/kde4 -DSERVICES_INSTALL_DIR=/usr/share/kde4/services . || return 1
	make || return 1
	make DESTDIR=${pkgdir} install || return 1
	rm -rf "${srcdir}/${_gitname}-build"
}

package_phonon-backend-vlc()
{
	pkgdesc="Phonon VLC backend"
	url="http://gitorious.org/phonon/phonon-vlc"
	license=('LGPL')
	depends=('vlc' "phonon>=${pkgver}")
	groups=("kde-complete" "kde-uninstall")
	replaces=('phonon-vlc-svn' 'phonon-vlc')
	conflicts=('phonon-vlc-svn' 'phonon-vlc')
	pkgver=$_vlc
	pkgrel=3

	cd ${srcdir}/build-phonon-vlc
	make DESTDIR=${pkgdir} install
} 
