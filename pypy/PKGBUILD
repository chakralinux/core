# Maintainer: Fabian Kosmale <inkane@chakra-project.org>
# Contributor: Daniele Cocca <jmc@chakra-project.org>

pkgname=pypy
pkgver=2.0.2
_shasum=('f66246c46ca3')
pkgrel=2
pkgdesc="PyPy is a fast, compliant alternative implementation of the Python language (2.7.1)."
arch=('x86_64')
url="http://www.pypy.org/"
license=('MIT')
depends=('expat' 'zlib' 'bzip2' 'openssl' 'python-greenlet' 'libffi')
makedepends=('pypy' 'sqlite3')
source=("https://bitbucket.org/${pkgname}/${pkgname}/downloads/$pkgname-$pkgver-src.tar.bz2" "LICENSE")
options=(!buildflags)
md5sums=('c26662e348159b460057548ddaf35333'
         'a6ed60c010618fd5bb8bad3570c5b8bd')

build() {
  cd "${srcdir}"/${pkgname}-${pkgver}-src/pypy/goal

  # here you can boostrap with python if needed
  pypy ../../rpython/bin/rpython -Ojit targetpypystandalone
}

package() {
  install -D -m644 LICENSE "${pkgdir}/usr/share/licences/${pkgname}/LICENSE"
  cd "${srcdir}"/${pkgname}-${pkgver}-src/pypy/tool/release

  cd "${srcdir}"/${pkgname}-${pkgver}-src/pypy/tool/release

  pypy package.py ../../../ pypy pypy-c "${srcdir}"/${pkgname}.tar.bz2

  mkdir -p "${pkgdir}"/opt
  tar x -C "${pkgdir}"/opt -f "${srcdir}"/${pkgname}.tar.bz2

  # Install binary symlink
  install -d -m755 "${pkgdir}/usr/bin"
  ln -sf "/opt/${pkgname}/bin/pypy-c" "${pkgdir}/usr/bin/pypy"

}
