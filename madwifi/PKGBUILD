#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

# include global config
source ../_buildscripts/${current_repo}-${_arch}-cfg.conf

# Find the kernel name inside the chroot
_kernver=`pacman -Q linux | cut -c7-9 | sed 's/linux //g'`-CHAKRA

pkgname=madwifi
pkgver=0.9.4.4133
pkgrel=12
pkgdesc="Madwifi drivers for Atheros wireless chipsets"
arch=(i686 x86_64)
license=('GPL')
url="http://madwifi-project.org"
depends=('madwifi-utils' 'linux>=3.1' 'linux<3.2')
makedepends=('linux-headers' 'sharutils')
install=madwifi-ng.install
# subversion source: svn checkout http:/madwifi-project.org/svn/madwifi/trunk madwifi
source=(ftp://ftp.archlinux.org/other/madwifi/madwifi-${pkgver}.tar.bz2
	#http://downloads.sourceforge.net/madwifi/madwifi-${pkgver}.tar.gz
        kernel-3.0-remove-check.patch
	)
groups=("linux-modules")
conflicts=("madwifi")
replaces=("madwifi")

build() {
  [ "${CARCH}" = "i686" ] && export ARCH=i386

  #cd $startdir/src/madwifi-$pkgver
  cd $startdir/src/madwifi
  patch -Np0 -i $srcdir/kernel-3.0-remove-check.patch
    sed \
    -e  's~#include <linux/config.h>~~g' \
    -i */*.c */*/*.c
  sed -i -e 's/-Werror//g' Makefile.inc
  make KERNELPATH=/lib/modules/$_kernver/build KERNELRELEASE=$_kernver modules|| return 1
  make KERNELPATH=/lib/modules/$_kernver/build KERNELRELEASE=$_kernver modules \
       DESTDIR=$startdir/pkg KERNELRELEASE=$_kernver install-modules
  sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" $startdir/*.install

  # install to wireless kernel directory
  mkdir -p $startdir/pkg/lib/modules/$_kernver/kernel/drivers/net/wireless/madwifi
  mv $startdir/pkg/lib/modules/$_kernver/net/* $startdir/pkg/lib/modules/$_kernver/kernel/drivers/net/wireless/madwifi
  rm -r $startdir/pkg/lib/modules/$_kernver/net/
}

md5sums=('ca3c3504d000e7b3d7063af46271c932'
         '413f8af124ae53fd5a20fb6b7c1c64cc')
