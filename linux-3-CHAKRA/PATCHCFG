# Source env-settings
source ../_buildscripts/`pwd | cut -d/ -f3`-${_arch}-makepkg.conf
# Pre-Patch settings
_patch="3.0.3pre"
_queue="3.0"
# Aufs
_aufs="3.0-20110815"
# Kernel source file
SRC="ftp://ftp.kernel.org/pub/linux/kernel/v3.0/linux-3.0.tar.bz2"
# Original source directory
SRCORIG="linux-3.0"
# Our source directory
SRCNAME="linux-3.0-CHAKRA"
# Patches:
#   URL%patchlevel
#  or
#   filename%patchlevel (file must be in patches subdirectory)
PATCHES=(
         # add upstream patch from 3.0 series
         ftp://ftp.kernel.org/pub/linux/kernel/v3.0/patch-3.0.3.gz%1

         # add latest fixes from stable queue, if needed
         # http://git.kernel.org/?p=linux/kernel/git/stable/stable-queue.git
         #http://chakra-project.org/sources/linux/patches/3/bugfix/$_patch.patch%1

         # fix #19234 i1915 display size
         http://chakra-project.org/sources/linux/patches/3/bugfix/fix-i915.patch%1

         # fix several webcams (https://bugzilla.kernel.org/show_bug.cgi?id=35922)
         http://chakra-project.org/sources/linux/patches/3/bugfix/webcam-usb_quirk_reset_resume.patch%1

         # set DEFAULT_CONSOLE_LOGLEVEL to 4 (same value as the 'quiet' kernel param)
         # remove this when a Kconfig knob is made available by upstream
         # (relevant patch sent upstream: https://lkml.org/lkml/2011/7/26/227)
         http://chakra-project.org/sources/linux/patches/3/bugfix/change-default-console-loglevel.patch%1

         # add aufs3 support, in reference to:
         # http://aufs.sourceforge.net
         http://chakra-project.org/sources/linux/patches/3/aufs3/aufs$_aufs-kbuild.patch%1
         http://chakra-project.org/sources/linux/patches/3/aufs3/aufs$_aufs-base.patch%1
         http://chakra-project.org/sources/linux/patches/3/aufs3/aufs$_aufs-standalone.patch%1
         http://chakra-project.org/sources/linux/patches/3/aufs3/aufs$_aufs.patch.bz2%1
        )
# Name of the resulting patch (will be bzipped afterwards)
PATCHNAME="patch-3.0.3-1-CHAKRA"

# Run this before applying patches
pre_apply() {
  :
}

# Run this after applying patches
post_apply() {
  # remove the sublevel and extraversion from Makefile
  # this ensures our kernel version is always 3.X-CHAKRA
  # this way, minor kernel updates will not break external modules
  sed -i 's|^SUBLEVEL = .*$|SUBLEVEL = |g' Makefile
  sed -i 's|^EXTRAVERSION = .*$|EXTRAVERSION = |g' Makefile

  # Kill some files
  find . -name '*~' -exec rm -f {} \; 2>/dev/null
}
