# Source env-settings
source ../_buildscripts/`pwd | cut -d/ -f3`-${_arch}-makepkg.conf
# Pre-Patch settings
_patch="3.1.9"
_prepatch="3.1.10-pre1"
_queue="3.1"
# Aufs
_aufs="3.1-20111114"
# Kernel source file
#SRC="ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-3.1.tar.bz2"
SRC="http://ftp.uni-erlangen.de/pub/mirrors/kernel.org/v3.x/linux-3.1.tar.bz2"
# Original source directory
SRCORIG="linux-3.1"
# Our source directory
SRCNAME="linux-3.1-CHAKRA"
# Patches:
#   URL%patchlevel
#  or
#   filename%patchlevel (file must be in patches subdirectory)
PATCHES=(
         # add upstream patch from 3.1 series
         ftp://ftp.kernel.org/pub/linux/kernel/v3.x/patch-$_patch.gz%1
         #http://ftp.uni-erlangen.de/pub/mirrors/kernel.org/v3.x/patch-$_patch.gz%1

         # add latest fixes from stable queue, if needed
         # http://git.kernel.org/?p=linux/kernel/git/stable/stable-queue.git
         http://chakra.sourceforge.net/sources/linux/patches/3.1/candidate/$_prepatch.patch%1
         #ftp://ftp.kernel.org/pub/linux/kernel/v3.x/stable-review/patch-$_prepatch.gz%1

         # Archlinux patches

         ### fix FS#27883
         ### drm/i915: Only clear the GPU domains upon a successful finish
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/i915-gpu-finish.patch%1

         ### Some chips detect a ghost TV output
         ### mailing list discussion: http://lists.freedesktop.org/archives/intel-gfx/2011-April/010371.html
         ### Arch Linux bug report: FS#19234
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/i915-fix-ghost-tv-output.patch%1

         ### In 3.1.1, a DRM_DEBUG message is falsely declared as DRM_ERROR. This
         #### worries users, as this message is displayed even at loglevel 4. Fix this.
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/i915-fix-incorrect-error-message.patch%1

         ### set DEFAULT_CONSOLE_LOGLEVEL to 4 (same value as the 'quiet' kernel param)
         ### remove this when a Kconfig knob is made available by upstream
         ### (relevant patch sent upstream: https://lkml.org/lkml/2011/7/26/227)
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/change-default-console-loglevel.patch%1

         # Custom Chakra Patches

         ### Power-Fix for 3.1 (https://lkml.org/lkml/2011/11/10/467)
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/rework-aspm-disable-code-3.1.patch%1

         ### add aufs3 support, in reference to:
         ### http://aufs.sourceforge.net
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs-kbuild.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs-base.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs-standalone.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs.patch.bz2%1

         ### add overlayfs v11 from git
         ### http://git.kernel.org/?p=linux/kernel/git/mszeredi/vfs.git;a=shortlog;h=refs/heads/overlayfs.v11
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/01-vfs_add-i_op-_open.patch.bz2%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/02-vfs_export-do_splice_direct-to-modules.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/03-vfs_introduce-clone_private_mount.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/04-overlay-filesystem.patch.bz2%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/05-overlayfs_add-statfs-support.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/06-overlayfs_implement-show_options.patch%1
         ### don't wanted feature
         #http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/08-fs_limit filesystem stacking depth.patch%1
         ### with Jordi Pujol's overlayfs patches following:
         ### for performance and improvement
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/50-copy-up-performance.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/51-improve-ovl_copy_up_xattr.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/52-vfs_getxattr-performance.patch%1
         ### suppress unreliable code, it confuses /proc/mounts
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/59-read-only.patch%1

         ### add quirk for other webcams
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/usb-add-quirk-for-other-webcams.patch%1

         ### add acerhk
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/01_acerhk-0.5.35.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/02_64bits_support_for_aspire5100.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/03_Add_Medion_MD97600_support.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/04_3rd-acerhk-proc_dir_entry-owner.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/05_kbuild.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/06_lindent.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/07_remove-ifdefs-for-ancient-kernels.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/08_remove-ifdefs-for-ACERDEBUG.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/09_kcompat-2.6.36.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/10_kcompat-2.6.38.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/11_bg-flag.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/12_Get-rid-off-bios-error.patch%1

         ### tomoyo 2.5
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/tomoyo/revert-tomoyo-fix-pathname-handling-of-disconnected-paths.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/tomoyo/revert-partly-fix-apparmor-dereferencing-potentially-freed-dentry-sanitize-__d_path-api.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/tomoyo/tomoyo-2.5-backport-from-3.2-rc5-for-3.1.5.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/tomoyo/tomoyo-2.5-backport-for-3.1.5.patch%1

         ### other features
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/v4l/0001-media-dvb-usb-prepare-for-multi-frontend-support-MFE.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/v4l/0002-media-dvb-usb-multi-frontend-support-MFE.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/v4l/0003-media-anysee-use-multi-frontend-MFE.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/v4l/0004-media-ttusb2-add-support-for-the-dvb-t-part-of-CT-36.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/v4l/0005-media-dvb-usb-refactor-MFE-code-for-individual-strea.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/ath_override-eeprom-countrycode.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/defaults-fat-utf8.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/dm-table-propagate-non-rotational-flag.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/module-bug-Add-TAINT_OOT_MODULE-flag-for-modules-not.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/mv_sas-OCZ-RevoDrive3-zDrive-R4-support.patch%1

        )
# Name of the resulting patch (will be bzipped afterwards)
PATCHNAME="patch-3.1.9-1-CHAKRA"

# Run this before applying patches
pre_apply() {
  :
}

# Run this after applying patches
post_apply() {
  # remove the sublevel and extraversion from Makefile
  # this ensures our kernel version is always 3.X-CHAKRA
  # this way, minor kernel updates will not break external modules
  sed -i 's|^SUBLEVEL = .*$|SUBLEVEL = |g' Makefile
  sed -i 's|^EXTRAVERSION = .*$|EXTRAVERSION = |g' Makefile

  # Kill some files
  find . -name '*~' -exec rm -f {} \; 2>/dev/null
}
