# Source env-settings
source ../_buildscripts/`pwd | cut -d/ -f3`-${_arch}-makepkg.conf
# Pre-Patch settings
_patch="3.1.1"
_prepatch="3.1.0"
_queue="3.1"
# Aufs
_aufs="3.1-20111031"
# Kernel source file
#SRC="ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-3.1.tar.bz2"
SRC="http://ftp.uni-erlangen.de/pub/mirrors/kernel.org/v3.x/linux-3.1.tar.bz2"
# Original source directory
SRCORIG="linux-3.1"
# Our source directory
SRCNAME="linux-3.1-CHAKRA"
# Patches:
#   URL%patchlevel
#  or
#   filename%patchlevel (file must be in patches subdirectory)
PATCHES=(
         # add upstream patch from 3.1 series
         #ftp://ftp.kernel.org/pub/linux/kernel/v3.1/patch-$_patch.gz%1
         #http://ftp.uni-erlangen.de/pub/mirrors/kernel.org/v3.1/patch-$_patch.gz%1

         # add latest fixes from stable queue, if needed
         # http://git.kernel.org/?p=linux/kernel/git/stable/stable-queue.git
         http://chakra.sourceforge.net/sources/linux/patches/3.1/upstream/$_prepatch.patch%1

         # fix #19234 i1915 display size
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/fix-i915.patch%1

         # set DEFAULT_CONSOLE_LOGLEVEL to 4 (same value as the 'quiet' kernel param)
         # remove this when a Kconfig knob is made available by upstream
         # (relevant patch sent upstream: https://lkml.org/lkml/2011/7/26/227)
         http://chakra.sourceforge.net/sources/linux/patches/3.1/bugfix/change-default-console-loglevel.patch%1

         # add aufs3 support, in reference to:
         # http://aufs.sourceforge.net
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs-kbuild.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs-base.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs-standalone.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/aufs3.1/aufs$_aufs.patch.bz2%1

         # add overlayfs v11 from git
         # http://git.kernel.org/?p=linux/kernel/git/mszeredi/vfs.git;a=shortlog;h=refs/heads/overlayfs.v11
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/01-vfs_add-i_op-_open.patch.bz2%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/02-vfs_export-do_splice_direct-to-modules.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/03-vfs_introduce-clone_private_mount.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/04-overlay-filesystem.patch.bz2%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/05-overlayfs_add-statfs-support.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/06-overlayfs_implement-show_options.patch%1
         # don't wanted feature
         #http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/08-fs_limit filesystem stacking depth.patch%1

         # with Jordi Pujol's overlayfs patches following:
         # for performance and improvement
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/50-copy-up-performance.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/51-improve-ovl_copy_up_xattr.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/52-vfs_getxattr-performance.patch%1
         # suppress unreliable code, it confuses /proc/mounts
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/overlayfs/59-read-only.patch%1

         # add fedora patches
         ## Standalone patches
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/taint-vbox.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-defaults-acpi-video.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-acpi-video-dos.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-acpi-debug-infinite-loop.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/acpi-ensure-thermal-limits-match-cpu-freq.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/acpi-sony-nonvs-blacklist.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-input-kill-stupid-messages.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6.30-no-pcspkr-modalias.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/die-floppy-die.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/floppy-drop-disable_hlt-warning.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-e1000-ich9-montevina.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-crash-driver.patch%1
         ## virt + ksm patches
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/fix_xen_guest_on_old_EC2.patch%1
         ## DRM
         ### nouveau + drm fixes
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/drm-nouveau-updates.patch%1
         ### make sure the lvds comes back on lid open
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/drm-intel-make-lvds-work.patch%1
         ### hush the i915 fbc noise
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/drm-i915-fbc-stfu.patch%1
         ### rhbz#729882, https://bugs.freedesktop.org/attachment.cgi?id=49069
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/drm-i915-sdvo-lvds-is-digital.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/drm-lower-severity-radeon-lockup.diff%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-intel-iommu-igfx.patch%1
         ## Quiet boot fixes
         ### silence the ACPI blacklist code
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/linux-2.6-silence-acpi-blacklist.patch%1
         ## patches headed upstream
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/add-appleir-usb-driver.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/disable-i8042-check-on-apple-mac.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/udlfb-bind-framebuffer-to-interface.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/x86-efi-Calling-__pa-with-an-ioremap-address-is-invalid.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/ums-realtek-driver-uses-stack-memory-for-DMA.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/epoll-fix-spurious-lockdep-warnings.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/rcu-avoid-just-onlined-cpu-resched.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/block-stray-block-put-after-teardown.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/usb-add-quirk-for-logitech-webcams.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/crypto-register-cryptd-first.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/epoll-limit-paths.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/dmar-disable-when-ricoh-multifunction.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/revert-efi-rtclock.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/efi-dont-map-boot-services-on-32bit.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/add-macbookair41-keyboard.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/hvcs_pi_buf_alloc.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/powerpc-Fix-deadlock-in-icswx-code.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/iwlagn-fix-ht_params-NULL-pointer-dereference.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/utrace.patch%1
         ## fixes
         ###rhbz #722509
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/mmc-Always-check-for-lower-base-frequency-quirk-for-.patch%1
         ###rhbz #735946
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/0001-mm-vmscan-Limit-direct-reclaim-for-higher-order-allo.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/0002-mm-Abort-reclaim-compaction-if-compaction-can-procee.patch%1
         ###rhbz 748691
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/be2net-non-member-vlan-pkts-not-received-in-promisco.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/benet-remove-bogus-unlikely-on-vlan-check.patch%1
         ###rhbz 749166
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/xfs-Fix-possible-memory-corruption-in-xfs_readlink.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/fedora/oom-fix-integer-overflow-of-points.patch%1

         # add acerhk
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/01_acerhk-0.5.35.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/02_64bits_support_for_aspire5100.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/03_Add_Medion_MD97600_support.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/04_3rd-acerhk-proc_dir_entry-owner.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/05_kbuild.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/06_lindent.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/07_remove-ifdefs-for-ancient-kernels.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/08_remove-ifdefs-for-ACERDEBUG.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/09_kcompat-2.6.36.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/acerhk/10_kcompat-2.6.38.patch%1

         # other features
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/linux-next/multitouch/0001-HID-hid-multitouch-Add-LG-Display-Multitouch-device.patch%1
         http://chakra.sourceforge.net/sources/linux/patches/3.1/features/linux-next/multitouch/0002-HID-hid-multitouch-add-support-for-the-IDEACOM-6650-.patch%1

        )
# Name of the resulting patch (will be bzipped afterwards)
PATCHNAME="patch-3.1.0-1-CHAKRA"

# Run this before applying patches
pre_apply() {
  :
}

# Run this after applying patches
post_apply() {
  # remove the sublevel and extraversion from Makefile
  # this ensures our kernel version is always 3.X-CHAKRA
  # this way, minor kernel updates will not break external modules
  sed -i 's|^SUBLEVEL = .*$|SUBLEVEL = |g' Makefile
  sed -i 's|^EXTRAVERSION = .*$|EXTRAVERSION = |g' Makefile

  # Kill some files
  find . -name '*~' -exec rm -f {} \; 2>/dev/null
}
